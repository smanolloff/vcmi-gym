cmake_minimum_required(VERSION 3.16.0)
project(connector LANGUAGES CXX)

set(CMAKE_MODULE_PATH ${CMAKE_HOME_DIRECTORY}/cmake_modules)

# https://stackoverflow.com/a/69527824
set(Python_VIRTUALENV FIRST)
set(CMAKE_CXX_STANDARD 17)
set(VCMI_DIR "${CMAKE_SOURCE_DIR}/../../vcmi")

# find_package(pybind11 REQUIRED)
add_subdirectory(pybind11)

if(APPLE)
    find_package(Boost REQUIRED COMPONENTS core format)
else()
    find_package(Boost REQUIRED system)
endif()


if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    set(DEBUG_BUILD 1)
    set(VCMI_BIN_PATH "${VCMI_DIR}/build/bin")
else()
    set(VCMI_BIN_PATH "${VCMI_DIR}/rel/bin")
endif()

find_library(LIBMLCLIENT NAMES mlclient PATHS "${VCMI_BIN_PATH}" NO_DEFAULT_PATH)

if(LIBMLCLIENT)
    message(STATUS "Found libmlclient: ${LIBMLCLIENT}")
else()
    message(FATAL_ERROR "libmlclient not found (searched in \"${VCMI_BIN_PATH}\")")
endif()

include_directories(SYSTEM ${Boost_INCLUDE_DIR})

#
# V12
#
set(CONNECTOR_V12_FILES v12/common.h v12/common.cpp v12/connector.cpp v12/threadconnector.h v12/threadconnector.cpp)
set(EXPORTER_V12_FILES v12/exporter.h v12/exporter.cpp)
pybind11_add_module(connector_v12 ${CONNECTOR_V12_FILES})
pybind11_add_module(exporter_v12 ${EXPORTER_V12_FILES})
target_include_directories(connector_v12 PUBLIC "${VCMI_DIR}")
target_include_directories(connector_v12 PUBLIC "${VCMI_DIR}/AI/MMAI")
target_include_directories(exporter_v12 PUBLIC "${VCMI_DIR}")
target_include_directories(exporter_v12 PUBLIC "${VCMI_DIR}/AI/MMAI")
target_link_libraries(connector_v12 PRIVATE "${Boost_LIBRARIES}")
target_link_libraries(connector_v12 PUBLIC ${LIBMLCLIENT})
set_property(TARGET exporter_v12 PROPERTY SUFFIX)
set_property(TARGET connector_v12 PROPERTY SUFFIX)
if(DEBUG_BUILD)
    target_compile_definitions(connector_v12 PRIVATE DEBUG_BUILD)
    target_compile_definitions(exporter_v12 PRIVATE DEBUG_BUILD)
endif()

#
# V13
#
set(CONNECTOR_V13_FILES v13/common.h v13/common.cpp v13/connector.cpp v13/threadconnector.h v13/threadconnector.cpp)
set(EXPORTER_V13_FILES v13/exporter.h v13/exporter.cpp)
pybind11_add_module(connector_v13 ${CONNECTOR_V13_FILES})
pybind11_add_module(exporter_v13 ${EXPORTER_V13_FILES})
target_include_directories(connector_v13 PUBLIC "${VCMI_DIR}")
target_include_directories(connector_v13 PUBLIC "${VCMI_DIR}/AI/MMAI")
target_include_directories(exporter_v13 PUBLIC "${VCMI_DIR}")
target_include_directories(exporter_v13 PUBLIC "${VCMI_DIR}/AI/MMAI")
target_link_libraries(connector_v13 PRIVATE "${Boost_LIBRARIES}")
target_link_libraries(connector_v13 PUBLIC ${LIBMLCLIENT})
set_property(TARGET exporter_v13 PROPERTY SUFFIX)
set_property(TARGET connector_v13 PROPERTY SUFFIX)
if(DEBUG_BUILD)
    target_compile_definitions(connector_v13 PRIVATE DEBUG_BUILD)
    target_compile_definitions(exporter_v13 PRIVATE DEBUG_BUILD)
endif()
